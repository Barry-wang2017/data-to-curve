import os
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import interpolate

def process_csv_files(directory, start_row, start_col, x_col, y_col, x_range, y_range, num_points, img_resolution):
    # Get all CSV files in the directory
    csv_files = [f for f in os.listdir(directory) if f.endswith('.csv')]
    
    # Calculate figure size in inches
    fig_width = img_resolution[1] / img_resolution[0]
    fig_height = img_resolution[2] / img_resolution[0]
    
    for file in csv_files:
        # Create a new figure for each file
        plt.figure(figsize=(fig_width, fig_height))
        
        # Read CSV file
        df = pd.read_csv(os.path.join(directory, file), skiprows=start_row-1)
        
        # Select columns from start_col to the end
        df = df.iloc[:, start_col-1:]
        
        # Check if x_col and y_col are within the DataFrame's columns
        if x_col-start_col >= df.shape[1] or y_col-start_col >= df.shape[1]:
            print(f"Warning: Specified columns are out of range for file {file}. Skipping this file.")
            plt.close()
            continue
        
        # Extract x and y data
        x = df.iloc[:, x_col-start_col].astype(float)
        y = df.iloc[:, y_col-start_col].astype(float)
        
        # Remove any rows with NaN values
        valid = ~(x.isna() | y.isna())
        x = x[valid]
        y = y[valid]
        
        if len(x) < 2:
            print(f"Warning: Not enough valid data points in file {file}. Skipping this file.")
            plt.close()
            continue
        
        # Interpolate data
        f = interpolate.interp1d(x, y)
        x_new = np.linspace(x.min(), x.max(), num_points)
        y_new = f(x_new)
        
        # Plot data
        plt.plot(x_new, y_new)
        
        plt.xlabel(f'Column {x_col}')
        plt.ylabel(f'Column {y_col}')
        plt.title(f'Data from {file}')
        
        # Set x and y range if provided
        if x_range:
            plt.xlim(x_range)
        if y_range:
            plt.ylim(y_range)
        
        # Save plot
        output_filename = os.path.splitext(file)[0] + '_plot.png'
        plt.savefig(os.path.join(directory, output_filename), dpi=img_resolution[0])
        plt.close()

# Example usage
directory = '/Users/barrywang/Documents/Python_work/iphone/D23'
start_row = 7  # Start processing from the second row
start_col = 1  # Start processing from the third column
x_col = 5  # Use the fourth column as x-axis
y_col = 6  # Use the fifth column as y-axis
x_range = (0, 145)  # Set x-axis range (min, max)
y_range = (-1.3, 1)  # Set y-axis range (min, max)
num_points = 400  # Number of points for interpolation
img_resolution = (300, 1920, 1080)  # DPI, width, height

process_csv_files(directory, start_row, start_col, x_col, y_col, x_range, y_range, num_points, img_resolution)
